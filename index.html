<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>En Yakın Popülasyonlar</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0}
    body{display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f3f4f6;padding:24px}
    .card{width:100%;max-width:900px;background:white;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.08);padding:24px}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:#4b5563}
    .field{display:flex;flex-direction:column;margin-bottom:8px}
    label{font-size:13px;margin-bottom:6px;color:#374151}
    input[type=text], input[type=number]{padding:6px 8px;border-radius:6px;border:1px solid #e5e7eb;font-size:13px;width:100%;box-sizing:border-box}
    input.invalid{border-color:#ef4444;background:#fff1f2}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:0;background:#111827;color:white;cursor:pointer}
    button:disabled{background:#9ca3af;cursor:not-allowed}
    button.secondary{background:#e5e7eb;color:#111827}
    .neighbors{margin-top:12px}
    .fst-results{margin-top:24px;padding-top:24px;border-top:1px solid #e5e7eb}
    table{border-collapse:collapse;width:100%;margin-top:8px}
    th,td{border:1px solid #e5e7eb;padding:6px 10px;text-align:left;font-size:14px}
    th{background:#f9fafb}
    
    /* 2 satır × 6 sütun grid */
    .inputs-grid{display:grid;grid-template-columns:repeat(6, 1fr);grid-template-rows:repeat(2, auto);gap:12px}
    .inputs-grid .field{flex-direction:column;margin-bottom:0}
    
    /* Responsive tasarım */
    @media (max-width: 768px) {
      .card {
        padding: 16px;
        margin: 16px;
      }
      
      .inputs-grid {
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(4, auto);
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 4px 6px;
      }
    }

    @media (max-width: 480px) {
      .inputs-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(6, auto);
      }
      
      .controls {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>En Yakın Popülasyonlar</h1>
    <p class="lead">Dodecad-k12b değerlerini ilgili kutucuklara girin ve "Hesapla" tuşuna basın. Program güncel popülasyon ortalamalarına göre en yakın sonuçları gösterecek.</p>

    <form id="numbersForm" onsubmit="return false;">
      <div class="field" style="max-width: 150px;">
        <label for="outputCount">Çıktı sayısı</label>
        <input type="number" id="outputCount" value="20" min="1" max="500">
      </div>

      <div id="inputs" class="inputs-grid"></div>

      <div class="controls">
        <button id="calcBtn">Hesapla</button>
        <button id="clearBtn" class="secondary" type="button">Temizle</button>
        <button id="reloadBtn" class="secondary" type="button">Verileri Yenile</button>
      </div>

      <div class="neighbors" id="neighbors"></div>
      <div class="fst-results" id="fstResults"></div>
    </form>
  </main>

  <script>
    const labels = [
      "Gedrosia",
      "Siberian",
      "Northwest African",
      "Southeast Asian",
      "Atlantic Med",
      "North European",
      "South Asian",
      "East African",
      "Southwest Asian",
      "East Asian",
      "Caucasus",
      "Sub-Saharan"
    ];

    // FST transformasyon matrisi
    const FST_TRANSFORMATION_MATRIX = [
      [ 0.01048873,  0.007743  , -0.01183824, -0.02538762,  0.01382825, -0.01971983,  0.01521575,  0.01617464, -0.00297412, -0.01915227, 0.00992257,  0.01501106],
      [-0.00815924, -0.02234599,  0.00763437, -0.03070027, -0.07001091, -0.01306848,  0.01259702, -0.02399722,  0.00719069,  0.04305844, 0.02408857,  0.0209619 ],
      [-0.02134918,  0.00865377,  0.00106844,  0.00647984,  0.03401198, 0.02175552,  0.00242823,  0.01928684, -0.00415826, -0.00538686, 0.0021384 , -0.0102777 ],
      [ 0.03255612, -0.02346179,  0.01151806,  0.01013345, -0.05600267, -0.01183162,  0.03720168, -0.03496955,  0.00849757,  0.04060607, -0.00453819,  0.01200958],
      [-0.01124391, -0.00048973, -0.02331613,  0.0014097 ,  0.02444862, 0.00629537,  0.00665833,  0.04085272,  0.02589211, -0.00856372, 0.00892602,  0.01718839],
      [-0.0017736 , -0.01663471, -0.02570414, -0.00663515,  0.01400947, -0.01148814,  0.00455466,  0.0396596 , -0.00225027, -0.00211916, 0.00767346,  0.0158262 ],
      [ 0.02744786, -0.01307196, -0.00086569, -0.01732965, -0.028969  , -0.01010476, -0.00684268,  0.00211261,  0.01853571, -0.00098844, -0.01809414, -0.02249732],
      [-0.00786016,  0.03464515,  0.01503417,  0.02854525,  0.03474362, 0.02849651, -0.05117144, -0.03552481, -0.03347181, -0.02302888, -0.01148592, -0.02255699],
      [-0.01889138, -0.00352634,  0.01225547,  0.01050122,  0.02901801, -0.01708262,  0.00175261,  0.03198801,  0.02164733, -0.02850526, -0.00204722,  0.00837268],
      [ 0.00837455, -0.02069362,  0.00296988, -0.00099411, -0.06394753, -0.01783585,  0.02700479, -0.03261083,  0.00599106,  0.03857869, -0.00876447,  0.0109065 ],
      [-0.00093434,  0.00531568, -0.01246633, -0.00167441,  0.01266372, -0.00013568,  0.01019727,  0.03119446,  0.01213548, -0.02097596, 0.0144362 ,  0.00417875],
      [-0.00865544,  0.04386654,  0.02371013,  0.02565175,  0.05620646, 0.04471957, -0.05959622, -0.05416647, -0.05703549, -0.01352266, -0.02225529, -0.04912303]
    ];

    const FST_DIVISOR = 100.076489495;

    const inputsEl = document.getElementById('inputs');
    const neighborsEl = document.getElementById('neighbors');
    const fstResultsEl = document.getElementById('fstResults');
    const calcBtn = document.getElementById('calcBtn');
    const clearBtn = document.getElementById('clearBtn');
    const reloadBtn = document.getElementById('reloadBtn');

    // Input alanlarını oluştur
    labels.forEach((labelText, i) => {
      const field = document.createElement('div');
      field.className = 'field';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = labelText;
      input.id = `input-${i}`;
      input.dataset.index = i;

      field.appendChild(input);
      inputsEl.appendChild(field);
    });

    function parseNumberRaw(raw) {
      if (raw === null) return NaN;
      raw = raw.toString().trim();
      if (raw === '') return NaN;
      raw = raw.replace(',', '.');
      const v = Number(raw);
      return Number.isFinite(v) ? v : NaN;
    }

    // Vektörü FST matrisi ile çarp ve bölen değere böl
    function transformVectorFST(vector) {
      const result = new Array(12).fill(0);
      
      for (let i = 0; i < 12; i++) {
        for (let j = 0; j < 12; j++) {
          result[i] += vector[j] * FST_TRANSFORMATION_MATRIX[i][j];
        }
        result[i] /= FST_DIVISOR;
      }
      
      return result;
    }

    function euclidean(a, b) {
      let s = 0;
      for (let i = 0; i < 12; i++) {
        const d = (a[i] || 0) - (b[i] || 0);
        s += d * d;
      }
      return Math.sqrt(s);
    }

    async function loadDataset(forceReload = false) {
      try {
        // Cache busting için timestamp ekle
        const timestamp = forceReload ? `?t=${Date.now()}` : '';
        const res = await fetch(`Dodecad_k12b_Averages.txt${timestamp}`);
        
        if (!res.ok) throw new Error(`Dosya yüklenemedi: ${res.status}`);
        const text = await res.text();
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        
        console.log(`Yüklenen veri seti satır sayısı: ${lines.length}`);
        
        return lines.map(line => {
          const parts = line.split(',').map(s => s.trim());
          const name = parts[0];
          const originalVector = parts.slice(1).map(s => parseFloat(s));
          const fstVector = transformVectorFST(originalVector);
          
          return { 
            name, 
            vector: originalVector,
            fstVector: fstVector
          };
        });
      } catch (error) {
        console.error('Veri seti yüklenirken hata:', error);
        neighborsEl.innerHTML = `<div style="color:#b91c1c">Veri seti yüklenirken hata oluştu: ${error.message}</div>`;
        return [];
      }
    }

    function validateInputs() {
      const inputs = Array.from(document.querySelectorAll('#inputs input'));
      let isValid = true;
      let total = 0;
      
      inputs.forEach(inp => {
        inp.classList.remove('invalid');
        const raw = inp.value;
        const v = parseNumberRaw(raw);
        
        if (Number.isNaN(v) || v < 0 || v > 100) {
          inp.classList.add('invalid');
          isValid = false;
        } else {
          total += v;
        }
      });
      
      if (isValid && Math.abs(total - 100) > 1) {
        neighborsEl.innerHTML = `<div style="color:#ca8a04">Uyarı: Değerlerin toplamı %${total.toFixed(2)}. Genellikle %100'e yakın olmalı.</div>`;
      }
      
      return isValid;
    }

    let datasetPromise = null;

    calcBtn.addEventListener('click', async () => {
      if (!validateInputs()) {
        neighborsEl.innerHTML = '<div style="color:#b91c1c">Lütfen kutucuklara 0-100 arasında geçerli sayılar giriniz.</div>';
        fstResultsEl.innerHTML = '';
        return;
      }

      const outputCount = parseInt(document.getElementById('outputCount').value, 10) || 20;

      calcBtn.disabled = true;
      calcBtn.textContent = 'Hesaplanıyor...';
      
      try {
        if (!datasetPromise) datasetPromise = loadDataset();
        const dataset = await datasetPromise;

        if (dataset.length === 0) {
          neighborsEl.innerHTML = '<div style="color:#b91c1c">Veri seti yüklenemedi veya boş.</div>';
          fstResultsEl.innerHTML = '';
          return;
        }

        console.log(`Hesaplama için ${dataset.length} popülasyon kullanılıyor`);

        const inputs = Array.from(document.querySelectorAll('#inputs input'));
        const originalValues = inputs.map(inp => parseNumberRaw(inp.value));
        
        const userFstVector = transformVectorFST(originalValues);

        // Normal mesafe hesaplama
        const normalResults = dataset.map(row => ({
          name: row.name,
          distance: euclidean(originalValues, row.vector)
        }));
        normalResults.sort((a, b) => a.distance - b.distance);

        // FST mesafe hesaplama
        const fstResults = dataset.map(row => ({
          name: row.name,
          distance: euclidean(userFstVector, row.fstVector)
        }));
        fstResults.sort((a, b) => a.distance - b.distance);

        // Sonuçları göster
        let normalHtml = `<strong>En yakın ${outputCount} (Normal)</strong>`;
        normalHtml += '<table><thead><tr><th>#</th><th>Popülasyon</th><th>Mesafe</th></tr></thead><tbody>';
        normalResults.slice(0, outputCount).forEach((item, idx) => {
          normalHtml += `<tr><td>${idx + 1}</td><td>${item.name}</td><td>${item.distance.toFixed(6)}</td></tr>`;
        });
        normalHtml += '</tbody></table>';
        neighborsEl.innerHTML = normalHtml;

        let fstHtml = `<strong>FST Sonuçları - En yakın ${outputCount}</strong>`;
        fstHtml += '<table><thead><tr><th>#</th><th>Popülasyon</th><th>FST Mesafe</th></tr></thead><tbody>';
        fstResults.slice(0, outputCount).forEach((item, idx) => {
          fstHtml += `<tr><td>${idx + 1}</td><td>${item.name}</td><td>${item.distance.toFixed(6)}</td></tr>`;
        });
        fstHtml += '</tbody></table>';
        fstResultsEl.innerHTML = fstHtml;

        saveInputs();
        
      } catch (error) {
        neighborsEl.innerHTML = `<div style="color:#b91c1c">Hesaplama sırasında hata: ${error.message}</div>`;
        fstResultsEl.innerHTML = '';
      } finally {
        calcBtn.disabled = false;
        calcBtn.textContent = 'Hesapla';
      }
    });

    // Yeni: Verileri yeniden yükle butonu
    reloadBtn.addEventListener('click', async () => {
      datasetPromise = null;
      neighborsEl.innerHTML = '<div style="color:#3b82f6">Veriler yeniden yükleniyor...</div>';
      fstResultsEl.innerHTML = '';
      
      try {
        datasetPromise = loadDataset(true);
        const dataset = await datasetPromise;
        neighborsEl.innerHTML = `<div style="color:#10b981">Veriler başarıyla yeniden yüklendi! ${dataset.length} popülasyon hazır.</div>`;
      } catch (error) {
        neighborsEl.innerHTML = `<div style="color:#b91c1c">Veriler yeniden yüklenirken hata: ${error.message}</div>`;
      }
    });

    clearBtn.addEventListener('click', () => {
      document.querySelectorAll('#inputs input').forEach(i => { i.value = ''; i.classList.remove('invalid'); });
      document.getElementById('outputCount').value = 20;
      neighborsEl.innerHTML = '';
      fstResultsEl.innerHTML = '';
      localStorage.removeItem('dodecadInputs');
    });

    function saveInputs() {
      const inputs = Array.from(document.querySelectorAll('#inputs input'));
      const values = inputs.map(input => input.value);
      localStorage.setItem('dodecadInputs', JSON.stringify(values));
    }

    function loadSavedInputs() {
      const saved = localStorage.getItem('dodecadInputs');
      if (saved) {
        try {
          const values = JSON.parse(saved);
          const inputs = Array.from(document.querySelectorAll('#inputs input'));
          inputs.forEach((input, index) => {
            if (values[index]) input.value = values[index];
          });
        } catch (e) {
          console.error('Kayıtlı veriler yüklenirken hata:', e);
        }
      }
    }

    inputsEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        calcBtn.click();
      }
    });

    document.querySelectorAll('#inputs input').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.remove('invalid');
      });
    });

    document.addEventListener('DOMContentLoaded', loadSavedInputs);
  </script>
</body>
</html>
