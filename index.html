<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>En Yakın Popülasyonlar</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0}
    body{display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f3f4f6;padding:24px}
    .card{width:100%;max-width:1200px;background:white;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.08);padding:24px}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:#4b5563}
    .field{display:flex;flex-direction:column;margin-bottom:8px}
    label{font-size:13px;margin-bottom:6px;color:#374151}
    input[type=text], input[type=number]{padding:6px 8px;border-radius:6px;border:1px solid #e5e7eb;font-size:13px;width:100%}
    input.invalid{border-color:#ef4444;background:#fff1f2}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:0;background:#111827;color:white;cursor:pointer}
    button:disabled{background:#9ca3af;cursor:not-allowed}
    button.secondary{background:#e5e7eb;color:#111827}
    .neighbors{margin-top:12px}
    table{border-collapse:collapse;width:100%;margin-top:8px}
    th,td{border:1px solid #e5e7eb;padding:6px 10px;text-align:left;font-size:14px}
    th{background:#f9fafb}
    .inputs-grid{display:grid;grid-template-columns:repeat(12, 1fr);gap:8px}
    .inputs-grid .field{flex-direction:column;margin-bottom:0}
    
    /* Responsive tasarım */
    @media (max-width: 1200px) {
      .inputs-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    @media (max-width: 768px) {
      .card {
        padding: 16px;
        margin: 16px;
      }
      
      .inputs-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 4px 6px;
      }
    }

    @media (max-width: 480px) {
      .inputs-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .controls {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>En Yakın Popülasyonlarr</h1>
    <p class="lead">12 kutucuğa değer girin ve "Hesapla" tuşuna basın. Program sizin değerlerinize göre <strong>Dodecad_k12b_Averages.txt</strong> içindeki popülasyonlara öklid mesafesini hesaplayacak ve en yakın sonuçları gösterecek.</p>

    <form id="numbersForm" onsubmit="return false;">
      <div class="field" style="max-width: 150px;">
        <label for="outputCount">Çıktı sayısı</label>
        <input type="number" id="outputCount" value="20" min="1" max="500">
      </div>

      <div id="inputs" class="inputs-grid"></div>

      <div class="controls">
        <button id="calcBtn">Hesapla</button>
        <button id="clearBtn" class="secondary" type="button">Temizle</button>
      </div>

      <div class="neighbors" id="neighbors"></div>
    </form>
  </main>

  <script>
    const labels = [
      "Gedrosia",
      "Siberian",
      "Northwest African",
      "Southeast Asian",
      "Atlantic Med",
      "North European",
      "South Asian",
      "East African",
      "Southwest Asian",
      "East Asian",
      "Caucasus",
      "Sub-Saharan"
    ];

    const inputsEl = document.getElementById('inputs');
    const neighborsEl = document.getElementById('neighbors');
    const calcBtn = document.getElementById('calcBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Input alanlarını oluştur (sadece placeholder, label yok)
    labels.forEach((labelText, i) => {
      const field = document.createElement('div');
      field.className = 'field';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = labelText;
      input.id = `input-${i}`;
      input.dataset.index = i;

      field.appendChild(input);
      inputsEl.appendChild(field);
    });

    function parseNumberRaw(raw) {
      if (raw === null) return NaN;
      raw = raw.toString().trim();
      if (raw === '') return NaN;
      raw = raw.replace(',', '.');
      const v = Number(raw);
      return Number.isFinite(v) ? v : NaN;
    }

    function euclidean(a,b) {
      let s = 0;
      for (let i=0;i<12;i++){ const d = (a[i]||0) - (b[i]||0); s += d*d; }
      return Math.sqrt(s);
    }

    async function loadDataset() {
      try {
        const res = await fetch('Dodecad_k12b_Averages.txt');
        if (!res.ok) throw new Error(`Dosya yüklenemedi: ${res.status}`);
        const text = await res.text();
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
        return lines.map(line => {
          const parts = line.split(',').map(s=>s.trim());
          const name = parts[0];
          const nums = parts.slice(1).map(s=>parseFloat(s));
          return { name, vector: nums };
        });
      } catch (error) {
        console.error('Veri seti yüklenirken hata:', error);
        neighborsEl.innerHTML = `<div style="color:#b91c1c">Veri seti yüklenirken hata oluştu: ${error.message}</div>`;
        return [];
      }
    }

    function validateInputs() {
      const inputs = Array.from(document.querySelectorAll('#inputs input'));
      let isValid = true;
      let total = 0;
      
      inputs.forEach(inp => {
        inp.classList.remove('invalid');
        const raw = inp.value;
        const v = parseNumberRaw(raw);
        
        if (Number.isNaN(v)) {
          inp.classList.add('invalid');
          isValid = false;
        } else {
          total += v;
        }
      });
      
      // Toplam %100'e yakın mı kontrol et
      if (isValid && Math.abs(total - 100) > 1) {
        neighborsEl.innerHTML = `<div style="color:#ca8a04">Uyarı: Değerlerin toplamı %${total.toFixed(2)}. Genellikle %100'e yakın olmalı.</div>`;
      }
      
      return isValid;
    }

    let datasetPromise = null;

    calcBtn.addEventListener('click', async ()=>{
      if (!validateInputs()) {
        neighborsEl.innerHTML = '<div style="color:#b91c1c">Lütfen tüm 12 kutucuğa geçerli sayılar girin.</div>';
        return;
      }

      const outputCount = parseInt(document.getElementById('outputCount').value, 10) || 20;

      // Yükleme durumu
      calcBtn.disabled = true;
      calcBtn.textContent = 'Hesaplanıyor...';
      
      try {
        if (!datasetPromise) datasetPromise = loadDataset();
        const dataset = await datasetPromise;

        if (dataset.length === 0) {
          neighborsEl.innerHTML = '<div style="color:#b91c1c">Veri seti yüklenemedi veya boş.</div>';
          return;
        }

        const inputs = Array.from(document.querySelectorAll('#inputs input'));
        const values = inputs.map(inp => parseNumberRaw(inp.value));

        const results = dataset.map(row => ({
          name: row.name,
          distance: euclidean(values, row.vector)
        }));
        results.sort((a,b)=>a.distance-b.distance);

        let html = `<strong>En yakın ${outputCount}</strong>`;
        html += '<table><thead><tr><th>#</th><th>Popülasyon</th><th>Mesafe</th></tr></thead><tbody>';
        results.slice(0,outputCount).forEach((item, idx) => {
          html += `<tr><td>${idx+1}</td><td>${item.name}</td><td>${item.distance.toFixed(6)}</td></tr>`;
        });
        html += '</tbody></table>';

        neighborsEl.innerHTML = html;

        // Girilen değerleri kaydet
        saveInputs();
        
      } catch (error) {
        neighborsEl.innerHTML = `<div style="color:#b91c1c">Hesaplama sırasında hata: ${error.message}</div>`;
      } finally {
        calcBtn.disabled = false;
        calcBtn.textContent = 'Hesapla';
      }
    });

    clearBtn.addEventListener('click', ()=>{
      document.querySelectorAll('#inputs input').forEach(i=>{ i.value=''; i.classList.remove('invalid'); });
      document.getElementById('outputCount').value = 20;
      neighborsEl.innerHTML = '';
      localStorage.removeItem('dodecadInputs');
    });

    // LocalStorage ile veri saklama
    function saveInputs() {
      const inputs = Array.from(document.querySelectorAll('#inputs input'));
      const values = inputs.map(input => input.value);
      localStorage.setItem('dodecadInputs', JSON.stringify(values));
    }

    function loadSavedInputs() {
      const saved = localStorage.getItem('dodecadInputs');
      if (saved) {
        try {
          const values = JSON.parse(saved);
          const inputs = Array.from(document.querySelectorAll('#inputs input'));
          inputs.forEach((input, index) => {
            if (values[index]) input.value = values[index];
          });
        } catch (e) {
          console.error('Kayıtlı veriler yüklenirken hata:', e);
        }
      }
    }

    // Klavye desteği
    inputsEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        calcBtn.click();
      }
    });

    // Input değişikliklerinde otomatik validasyon
    document.querySelectorAll('#inputs input').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.remove('invalid');
      });
    });

    // Sayfa yüklendiğinde kayıtlı verileri yükle
    document.addEventListener('DOMContentLoaded', loadSavedInputs);
  </script>
</body>
</html>
